<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert Full Site to PDF</title>
    <style>
        /* CSS для разрывов страниц */
        @media print {
            h2 {
                page-break-before: always; /* Разрыв страницы перед каждым заголовком */
            }
            body {
                margin: 20px; /* Увеличиваем отступы для лучшего отображения */
            }
            ul {
                list-style-type: none; /* Убираем маркеры списка в PDF */
                padding-left: 0; /* Убираем отступ слева */
            }
            img {
                display: block; /* Делаем изображения блочными элементами */
                margin: 0 auto; /* Центрируем изображения */
                max-width: 50%; /* Максимальная ширина 50% */
                min-width: 30%; /* Минимальная ширина 30% */
                height: auto; /* Сохраняем пропорции изображения */
            }
        }
    </style>
    <script>
        async function fetchImage(url) {
            const response = await fetch(url);
            const blob = await response.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    resolve(reader.result);
                };
                reader.readAsDataURL(blob);
            });
        }

        async function fetchAndConvertToPDF() {
            const urls = [
                {name: "Назначение", url: "https://telecontrol-ru.github.io/scada/"},
                {name: "Начало работы", url: "https://telecontrol-ru.github.io/scada/getting-started"},
                {name: "Архитектура", url: "https://telecontrol-ru.github.io/scada/architecture"},
                {name: "Сервер", url: "https://telecontrol-ru.github.io/scada/server"},
                {name: "Клиент", url: "https://telecontrol-ru.github.io/scada/client"},
                {name: "График", url: "https://telecontrol-ru.github.io/scada/client/graph"},
                {name: "Мнемосхема", url: "https://telecontrol-ru.github.io/scada/client/display"},
                {name: "Таблица", url: "https://telecontrol-ru.github.io/scada/client/table"},
                {name: "Проектирование", url: "https://telecontrol-ru.github.io/scada/development"},
                {name: "История изменений", url: "https://telecontrol-ru.github.io/scada/changes"}
            ];

            let fullContent = '<h1>Навигация по разделам</h1><ul>';

            for (let i = 0; i < urls.length; i++) {
                const { name, url } = urls[i];
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch content from ${url}`);
                    }
                    const content = await response.text();

                    const absoluteContent = await replaceRelativeImages(content, url);

                    fullContent += `<li><a href="#section-${i}">${name}</a></li>`;
                    fullContent += `<h2 id="section-${i}">${name}</h2>`;
                    fullContent += `<div style="page-break-after: always;">${absoluteContent}</div>`;  // Разрыв после контента

                } catch (error) {
                    console.error("Error fetching or converting the page:", error);
                }
            }

            fullContent += '</ul>';  // Завершение списка навигации

            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write(fullContent);
            printWindow.document.close();

            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
            };
        }

        async function replaceRelativeImages(content, baseUrl) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');

            const images = doc.querySelectorAll('img');
            for (let img of images) {
                const src = img.getAttribute('src');
                if (src && !src.startsWith('http')) {
                    const imageUrl = new URL(src, baseUrl).href; // Создаем абсолютный URL
                    const base64Image = await fetchImage(imageUrl);
                    img.setAttribute('src', base64Image); // Устанавливаем base64 URL
                }
                img.style.maxWidth = '100%'; // Устанавливаем максимальную ширину
                img.style.minWidth = '1%'; // Устанавливаем минимальную ширину
                img.style.display = 'block'; // Делаем изображение блочным
                img.style.margin = '0 auto'; // Центрируем изображение
            }

            return doc.body.innerHTML; // Возвращаем обновленный HTML
        }
    </script>
</head>
<body>
    <h1>Конвертация всего сайта в PDF</h1>
    <button onclick="fetchAndConvertToPDF()">Конвертировать в PDF</button>
</body>
</html>